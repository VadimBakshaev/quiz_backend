(()=>{"use strict";const e="http://localhost:3000/api";class t{static async processUnauthorizedResponse(){const t=localStorage.getItem("refreshToken");if(t){const s=await fetch(e+"/refresh",{method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},body:JSON.stringify({refreshToken:t})});if(!s||200!==s.status)return this.removeTokens(),location.href="#/",!1;{const e=await s.json();if(e&&!e.error)return this.setTokens(e.accessToken,e.refreshToken),!0}}}static async logout(){const t=localStorage.getItem("refreshToken");if(t){const s=await fetch(e+"/logout",{method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},body:JSON.stringify({refreshToken:t})});if(s&&200===s.status){const e=await s.json();if(e&&!e.error)return this.removeTokens(),localStorage.removeItem("userInfo"),!0}}}static setTokens(e,t){localStorage.setItem("accessToken",e),localStorage.setItem("refreshToken",t)}static removeTokens(){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}static setUserInfo(e){localStorage.setItem("userInfo",JSON.stringify(e))}static getUserInfo(){const e=localStorage.getItem("userInfo");return e?JSON.parse(e):null}}class s{static async request(e,s="GET",i=null){const n={method:s,headers:{"Content-type":"application/json",Accept:"application/json"}};let r=localStorage.getItem("accessToken");r&&(n.headers["x-access-token"]=r),i&&(n.body=JSON.stringify(i));const o=await fetch(e,n);if(o.status<200||o.status>=300){if(401===o.status)return await t.processUnauthorizedResponse()?await this.request(e,s,i):null;throw new Error(o.message)}return await o.json()}}class i{constructor(e){if(localStorage.getItem("accessToken"))return void(location.href="#/choice");this.page=e,this.formElement=null,this.agreeElement=null,this.processElement=null;const t=this;this.fields=[{name:"email",element:null,regex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,valid:!1},{name:"password",element:null,regex:/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[a-zA-Z0-9]{6,}$/,valid:!1}],"signup"===this.page&&(this.fields.unshift({name:"firstName",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"lastName",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1}),this.agreeElement=document.getElementById("agree"),this.agreeElement.addEventListener("change",function(){t.validateForm()})),this.fields.forEach(e=>{e.element=document.getElementById(e.name),e.element.addEventListener("change",function(){t.validateField(e,this)})}),this.formElement=document.querySelector(".form"),this.formElement.addEventListener("submit",function(e){e.preventDefault(),t.processForm()}),this.processElement=document.querySelector(".form-btn")}validateField(e,t){t.value&&t.value.match(e.regex)?(t.parentNode.removeAttribute("style"),e.valid=!0):(t.parentNode.style.borderColor="red",e.valid=!1),this.validateForm()}validateForm(){return(this.agreeElement?this.fields.every(e=>e.valid)&&this.agreeElement.checked:this.fields.every(e=>e.valid))?(this.processElement.removeAttribute("disabled"),!0):(this.processElement.setAttribute("disabled","disabled"),!1)}async processForm(){if(this.validateForm()){const i=this.fields.find(e=>"email"===e.name).element.value,n=this.fields.find(e=>"password"===e.name).element.value;if("signup"===this.page)try{const t=await s.request(e+"/signup","POST",{name:this.fields.find(e=>"firstName"===e.name).element.value,lastName:this.fields.find(e=>"lastName"===e.name).element.value,email:i,password:n});if(t&&(t.error||!t.user))throw new Error(t.message)}catch(e){return console.log(e)}try{const r=await s.request(e+"/login","POST",{email:i,password:n});if(r){if(r.error||!r.accessToken||!r.refreshToken||!r.fullName||!r.userId)throw new Error(r.message);t.setTokens(r.accessToken,r.refreshToken),t.setUserInfo({fullName:r.fullName,userId:r.userId,email:i}),location.href="#/choice"}}catch(e){console.log(e)}}}}class n{constructor(){this.quizzes=[],this.testResults=null,this.init(),this.user=t.getUserInfo()}async init(){try{const t=await s.request(e+"/tests");if(t){if(t.error)throw new Error(t.error);this.quizzes=t}}catch(e){return console.log(e)}if(this.user)try{const t=await s.request(e+"/tests/results?userId="+this.user.userId);if(t){if(t.error)throw new Error(t.error);this.testResults=t}}catch(e){return console.log(e)}this.processQuizzes()}processQuizzes(){if(this.quizzes&&this.quizzes.length>0){const e=document.querySelector(".choice-content"),t=this;this.quizzes.forEach(s=>{const i=document.createElement("div");i.className="choice-option",i.setAttribute("data-id",s.id),i.addEventListener("click",function(){t.chooseQuiz(this)});const n=document.createElement("div");n.className="choice-option-text",n.innerText=s.name;const r=document.createElement("div");r.className="choice-option-arrow";const o=this.testResults.find(e=>e.testId===s.id);if(o){const e=document.createElement("div");e.className="choice-option-result",e.innerHTML=`<div>Результат</div><div>${o.score}/${o.total}</div>`,i.appendChild(e)}const l=document.createElement("img");l.setAttribute("src","./static/images/arrow.svg"),l.setAttribute("alt","Arrow to right"),r.appendChild(l),i.appendChild(n),i.appendChild(r),e.appendChild(i)})}}chooseQuiz(e){const s=e.getAttribute("data-id");if(s){const e=t.getUserInfo();e&&(e.dataId=s,t.setUserInfo(e),location.href="#/test")}}}class r{constructor(){this.titleEl=null,this.optionsEl=null,this.quiz=null,this.progressBar=null,this.prevBtnEl=null,this.nextBtnEl=null,this.skipEl=null,this.currentQuestionIndex=1,this.userResult=[],this.user=t.getUserInfo(),this.init()}async init(){if(this.user)try{const t=await s.request(e+"/tests/"+this.user.dataId);if(t){if(t.error)throw new Error(t.error);this.quiz=t,this.startQuiz()}}catch(e){console.log(e)}}startQuiz(){document.querySelector(".test-pre-title").innerText=this.quiz.name,this.progressBar=document.querySelector(".test-progress-bar"),this.titleEl=document.querySelector(".test-question"),this.optionsEl=document.querySelector(".test-question-options"),this.skipEl=document.querySelector(".test-action-skip"),this.prevBtnEl=document.querySelector(".test-actions-prev"),this.prevBtnEl.addEventListener("click",()=>{this.move("prev")}),this.nextBtnEl=document.querySelector(".test-actions-next"),this.nextBtnEl.addEventListener("click",()=>{this.move("next")}),document.querySelector(".test-action-skip").addEventListener("click",()=>{this.move("skip")}),this.prepareProgressBar(),this.showQuestion();const e=document.querySelector(".test-actions-time-clock");let t=59;this.interval=setInterval(function(){e.innerText=t,t--,0===t&&this.complete()}.bind(this),1e3)}prepareProgressBar(){for(let e=0;e<this.quiz.questions.length;e++){const t=document.createElement("div");t.className="progress-bar-item"+(0===e?" active":"");const s=document.createElement("div");s.className="progress-bar-item-circle";const i=document.createElement("div");i.className="progress-bar-item-text",i.innerText=`Вопрос ${e+1}`,t.appendChild(s),t.appendChild(i),this.progressBar.appendChild(t)}}showQuestion(){const e=this,t=this.quiz.questions[this.currentQuestionIndex-1],s=this.userResult.find(e=>e.questionId===t.id);this.titleEl.innerHTML=`<span>Вопрос ${this.currentQuestionIndex}:</span> ${t.question}`,this.optionsEl.innerHTML="",t.answers.forEach(t=>{const i=document.createElement("div");i.className="test-question-option";const n=document.createElement("input");n.className="option-answer",n.setAttribute("id","answer-"+t.id),n.setAttribute("type","radio"),n.setAttribute("name","answer"),n.setAttribute("value",t.id),s&&s.chosenAnswerId===t.id&&(n.setAttribute("checked","checked"),e.skipEl.classList.add("disabled")),n.addEventListener("change",function(){e.chooseAnswer()});const r=document.createElement("label");r.setAttribute("for","answer-"+t.id),r.innerText=t.answer,i.appendChild(n),i.appendChild(r),e.optionsEl.appendChild(i)}),s&&s.chosenAnswerId?this.nextBtnEl.removeAttribute("disabled"):(this.nextBtnEl.setAttribute("disabled","disabled"),this.skipEl.classList.remove("disabled")),this.currentQuestionIndex===this.quiz.questions.length?(this.nextBtnEl.innerText="Завершить",this.skipEl.classList.add("disabled")):this.nextBtnEl.innerText="Дальше",this.currentQuestionIndex>1?this.prevBtnEl.removeAttribute("disabled"):this.prevBtnEl.setAttribute("disabled","disabled")}chooseAnswer(){this.nextBtnEl.removeAttribute("disabled"),this.skipEl.classList.add("disabled")}move(e){const t=Array.from(document.querySelectorAll(".option-answer")).find(e=>e.checked),s=this.quiz.questions[this.currentQuestionIndex-1];let i=null;t&&t.value&&(i=Number(t.value));const n=this.userResult.find(e=>e.questionId===s.id);n?n.choosenAnswerId=i:this.userResult.push({questionId:s.id,chosenAnswerId:i}),"next"===e||"skip"===e?this.currentQuestionIndex++:this.currentQuestionIndex--,this.currentQuestionIndex>this.quiz.questions.length?this.complete():(Array.from(this.progressBar.children).forEach((e,t)=>{e.classList.remove("complete"),e.classList.remove("active"),t+1===this.currentQuestionIndex?e.classList.add("active"):t+1<this.currentQuestionIndex&&e.classList.add("complete")}),this.showQuestion())}async complete(){clearInterval(this.interval);try{const i=await s.request(e+"/tests/"+this.user.dataId+"/pass","POST",{userId:this.user.userId,results:this.userResult});if(i){if(i.error)throw new Error(i.error);this.user.score=i.score,this.user.total=i.total,t.setUserInfo(this.user),location.href="#/result"}}catch(e){console.log(e)}}}class o{constructor(){const e=t.getUserInfo();e&&(document.querySelector(".result-score").innerText=`${e.score}/${e.total}`)}}class l{constructor(){this.quiz=null,this.answerBoxEl=document.querySelector(".answers-box"),this.user=t.getUserInfo(),this.init()}async init(){try{if(this.quiz=await s.request(e+"/tests/"+this.user.dataId+"/result/details?userId="+this.user.userId),this.quiz){if(this.quiz.error)throw new Error(this.quiz.error);document.querySelector(".answers-bread-crumbs-current").innerText=this.quiz.test.name,document.querySelector(".answers-user").innerText=`${this.user.fullName}, ${this.user.email}`,this.showAnswers()}}catch(e){console.log(e)}}showAnswers(){for(let e=0;e<this.quiz.test.questions.length;e++){const t=document.createElement("div");t.className="answers-answer",t.innerHTML=`<span>Вопрос ${e+1}:</span> ${this.quiz.test.questions[e].question}`,this.answerBoxEl.appendChild(t);for(let t=0;t<this.quiz.test.questions[e].answers.length;t++){const s=document.createElement("div");s.className="answers-user-answer",void 0!==this.quiz.test.questions[e].answers[t].correct&&(this.quiz.test.questions[e].answers[t].correct?s.classList.add("correct"):s.classList.add("uncorrect")),s.innerText=this.quiz.test.questions[e].answers[t].answer,this.answerBoxEl.appendChild(s)}}}}class a{constructor(){this.contentEl=document.getElementById("content"),this.stylesEl=document.getElementById("styles"),this.titleEl=document.getElementById("page-title"),this.profileEl=document.querySelector(".profile"),this.profileUserEl=document.querySelector(".profile-user"),this.routes=[{route:"#/",title:"Главная",template:"templates/index.html",styles:"styles/index.css",load:()=>{}},{route:"#/signup",title:"Регистрация",template:"templates/signup.html",styles:"styles/form.css",load:()=>{new i("signup")}},{route:"#/login",title:"Вход в систему",template:"templates/login.html",styles:"styles/form.css",load:()=>{new i("login")}},{route:"#/choice",title:"Выбор теста",template:"templates/choice.html",styles:"styles/choice.css",load:()=>{new n}},{route:"#/test",title:"Прохождение теста",template:"templates/test.html",styles:"styles/test.css",load:()=>{new r}},{route:"#/result",title:"Результат",template:"templates/result.html",styles:"styles/result.css",load:()=>{new o}},{route:"#/answers",title:"Ответы",template:"templates/answers.html",styles:"styles/answers.css",load:()=>{new l}}]}async openRoute(){if("#/logout"===location.hash)return await t.logout(),void(location.href="#/");const e=this.routes.find(e=>e.route===location.hash);if(!e)return void(location.href="#/");this.contentEl.innerHTML=await fetch(e.template).then(e=>e.text()),this.stylesEl.setAttribute("href",e.styles),this.titleEl.innerText=e.title;const s=t.getUserInfo(),i=localStorage.getItem("accessToken");s&&i?(this.profileEl.style.display="flex",this.profileUserEl.innerText=s.fullName):this.profileEl.style.display="none",e.load()}}new class{constructor(){this.router=new a,window.addEventListener("DOMContentLoaded",this.handleRouteChanging.bind(this)),window.addEventListener("popstate",this.handleRouteChanging.bind(this))}handleRouteChanging(){this.router.openRoute()}}})();